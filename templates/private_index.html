<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.12.5/umd/popper.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.staticfile.org/vue/2.2.2/vue.min.js"></script>
    <script src="https://cdn.staticfile.org/vue-resource/1.5.1/vue-resource.min.js"></script>
    <script src="http://momentjs.cn/downloads/moment.js"></script>
    <style>
        body{
            padding-top: 70px;
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div class="navbar navbar-expand-md bg-light fixed-top">
            <div class="container-fluid">
                <ul class="navbar-nav navbar-left nav-pills">
                    <li class="nav-item">
                        <a class="nav-link" href="/">主页</a>
                    </li>
                    <template v-if="logined">
                    <li class="nav-item">
                        <a class="nav-link" href="/notifygo">通知</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/lettergo">私信</a>
                    </li>
                    </template>
                </ul>
                <span class="navbar-text text-muted font-weight-bold">
                    迷你博客
                </span>
                <template v-if="logined">
                    <ul class="navbar-nav navbar-right">
                        <li class="navbar-text text-muted">
                            你好，{% verbatim %} {{ logined_username }} {% endverbatim %}&nbsp;&nbsp;&nbsp;&nbsp;
                        </li>
                        <li><button type="button" class="btn btn-primary" v-on:click="to_post()">发微博</button></li>
                        <li><button type="button" v-on:click="to_signout" class="btn btn-danger">注销</button></li>
                    </ul>
                </template>
                <template v-else>
                    <ul class="navbar-nav navbar-right">
                        <li>
                            <input type="text" v-model="user_name_login" class="form-control" placeholder="用户名">
                        </li>
                        <li>
                            <input type="password" v-model="user_password_login" v-on:keyup.enter="post_to_login()" class="form-control" placeholder="密码">
                        </li>
                        <li>
                            <button type="button" v-on:click="post_to_login()" class="btn btn-primary">登录</button>
                        </li>
                        <li>
                            <button type="button" v-on:click="to_register()" class="btn btn-success">注册</button>
                        </li>
                        <li>
                            <button type="button" v-on:click="to_forgetPassword()" class="btn">忘记密码</button>
                        </li>
                    </ul>
                </template>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-1"></div>
                <div class="col-md-3">
                    <div class="card">
                        <img class="card-img-top" src="/static/tou.jpg" style="width:100%">
                        <div class="card-body">
                            <h4 class="card-title"><a href="#" v-on:click="private_index_go(user_id)">{% verbatim %} {{ user_name }} {% endverbatim %}</a></h4>
                            <table>
                                <tbody>
                                    <tr>
                                        <td class="text-primary">粉丝</td>
                                        <td class="text-primary">关注</td>
                                        <td class="text-primary">微博</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">{% verbatim %} {{ user_vic_focus_num }} {% endverbatim %}</td>
                                        <td class="text-muted">{% verbatim %} {{ user_focus_num }} {% endverbatim %}</td>
                                        <td class="text-muted">{% verbatim %} {{ user_posts_num }} {% endverbatim %}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <template v-if="logined">
                            <template v-if="logined_username === user_name">

                            </template>
                            <template v-else>
                                <div class="card-footer">
                                <template v-if="is_focus">
                                    <button type="button" class="btn btn-info">已关注</button>
                                </template>
                                <template v-else>
                                    <button type="button" v-on:click="to_focus_him()" class="btn btn-info">关注</button>
                                </template>
                                <button type="button" v-on:click="open_letterModal()" class="btn btn-info">私信</button>
                            </div>
                            </template>
                        </template>
                    </div>
                </div>
                <div class="col-md-5">
                    <template v-for="p in posts">
                        <div class="card">
                            <div  v-on:click="open_modal(p)" class="card-body">
                                <h4><a href="#" v-on:click="private_index_go(p.poster.id)">{% verbatim %} {{ p.poster.username }} {% endverbatim %}</a></h4>
                                <p>{% verbatim %} {{ p.time | formatDate }} {% endverbatim %}</p>
                                <template v-if="p.type===1">
                                    <img v-bind:src="p.img" style="width:100%;">
                                </template>
                                <template v-else>
                                    <iframe v-bind:src="p.img" style="width:100%;height:350px" frameborder="0" allowfullscreen="allowfullscreen"></iframe>
                                </template>
                                <p>{% verbatim %} {{ p.content }} {% endverbatim %}</p>
                            </div>
                            <div class="card-footer">
                                <p>点赞数{% verbatim %} {{ p.like }} {% endverbatim %}</p>
                                <p>阅读量{% verbatim %} {{ p.reading }} {% endverbatim %}</p>
                            </div>
                        </div>
                    </template>
                    <!--推文模态框-->
                    <div class="modal fade" id="myModal" style="overflow: auto">
                        <div class="modal-dialog" aria-hidden="true">
                            <div class="modal-content">
                                <!-- 模态框头部 -->
                                <div class="modal-header">
                                    <h4 class="modal-title"><a href="#" v-on:click="private_index_go(modal.poster.id)">{% verbatim %} {{ modal.poster.username }} {% endverbatim %}</a></h4>
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                </div>
                                <!-- 模态框主体 -->
                                <div class="modal-body">
                                    <template v-if="modal.type===1">
                                        <img v-bind:src="modal.img" style="width:100%;">
                                    </template>
                                    <template v-else>
                                        <iframe v-bind:src="modal.img" style="width:100%;height:300px" frameborder="0" allowfullscreen="allowfullscreen"></iframe>
                                    </template>
                                    <div>{% verbatim %} {{ modal.content }} {% endverbatim %}</div>
                                    <div>{% verbatim %} {{ modal.time | formatDate }} {% endverbatim %}</div>
                                    <div>点赞数{% verbatim %} {{ modal.likes }} {% endverbatim %}</div>
                                    <div>阅读量{% verbatim %} {{ modal.hits }} {% endverbatim %}</div>
                                    <button v-on:click="post_i_like()">点赞</button>
                                    <button v-on:click="to_comment(modal)">评论</button>
                                    <!--评论-->
                                    <template v-for="comment in modal.comments">
                                        <hr>
                                        <div><a href="#" v-on:click="private_index_go(comment.poster.id)">{% verbatim %} {{ comment.poster.username }} {% endverbatim %}</a></div>
                                        <div>{% verbatim %} {{ comment.time | formatDate }} {% endverbatim %}</div>
                                        <div>{% verbatim %} {{ comment.content }} {% endverbatim %}</div>
                                        <button v-on:click="to_reply(comment,comment.id)">回复</button>
                                        <button data-toggle="collapse" v-bind:data-target="comment.target" v-on:click="post_replies(comment)">回复折叠</button>
                                        <div v-bind:id="comment.id" class="collapse">
                                            <template v-for="reply in comment.replies">
                                            <div>
                                                <a href="#" v-on:click="private_index_go(reply.poster.id)">{% verbatim %} {{ reply.poster.username }} {% endverbatim %}</a>
                                                回复
                                                <a href="#" v-on:click="private_index_go(reply.vic_reply.id)">{% verbatim %} {{ reply.vic_reply.username }} {% endverbatim %}</a>
                                            </div>
                                            <div>{% verbatim %} {{ reply.time | formatDate }} {% endverbatim %}</div>
                                            <div>{% verbatim %} {{ reply.content }} {% endverbatim %}</div>
                                            <button v-on:click="to_reply(reply,comment.id)">回复</button>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                                <!-- 模态框底部 -->
                                <div class="modal-footer">

                                </div>
                            </div>
                        </div>
                    </div>
                    <!--输入模态框-->
                    <div class="modal fade" id="inputModal">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <!-- 模态框头部 -->
                                <div class="modal-header">
                                    <h4 class="modal-title">对{% verbatim %} {{ inputModal.vic_poster.username }} {% endverbatim %}说</h4>
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                </div>
                                <!-- 模态框主体 -->
                                <div class="modal-body">
                                    <div>
                                        @
                                        <input type="text" v-model="inputModal.at_input" v-on:keyup.enter="inputModal_check_at_input()" class="form-control">
                                        <button type="button" class="btn" v-on:click="inputModal_check_at_input()">添加</button>
                                        <template v-for="at in inputModal.at_list">
                                            <a href="#" v-on:click="private_index_go(at.id)">@{% verbatim %} {{ at.username }} {% endverbatim %}</a>
                                        </template>
                                    </div>
                                    <textarea type="text" v-model="inputModal.content" class="form-control" rows="5"></textarea>
                                </div>
                                <!-- 模态框底部 -->
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" v-on:click="update_modal()">提交</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--发推模态框-->
                    <div class="modal fade" id="postModal">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <!-- 模态框头部 -->
                                <div class="modal-header">
                                    <h4 class="modal-title">发微博</h4>
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                </div>
                                <!-- 模态框主体 -->
                                <div class="modal-body">
                                    <div>图片链接</div>
                                    <input type="text" v-model="postModal.img_input" class="form-control">
                                    <button type="button" class="btn" v-on:click="update_postModal_img()">更新</button>
                                    <template v-if="postModal.type===1">
                                        <img v-bind:src="postModal.img_link" style="width:100%;">
                                    </template>
                                    <template v-else>
                                        <iframe v-bind:src="postModal.img_link" style="width:100%;height:300px" frameborder="0" allowfullscreen="allowfullscreen"></iframe>
                                    </template>
                                    <div>
                                        @
                                        <input type="text" v-model="postModal.at_input" v-on:keyup.enter="postModal_check_at_input()" class="form-control">
                                        <button type="button" class="btn" v-on:click="postModal_check_at_input()">添加</button>
                                        <template v-for="at in postModal.at_list">
                                            <a href="#" v-on:click="private_index_go(at.id)">@{% verbatim %} {{ at.username }} {% endverbatim %}</a>
                                        </template>
                                    </div>
                                    <textarea type="text" v-model="postModal.content" class="form-control" rows="5"></textarea>
                                </div>
                                <!-- 模态框底部 -->
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" v-on:click="post_postModal_to_post()">发表</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--私信模态框-->
                    <div class="modal fade" id="letterModal">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <!-- 模态框头部 -->
                                <div class="modal-header">
                                    <h4 class="modal-title">向{% verbatim %} {{ user_name }} {% endverbatim %}私信</h4>
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                </div>
                                <!-- 模态框主体 -->
                                <div class="modal-body">
                                    <input type="text" v-model="letter_input" class="form-control">
                                </div>
                                <!-- 模态框底部 -->
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" v-on:click="post_letter()">发送</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <!--关注折叠-->
                    <div class="card">
                        <div class="card-header">
                            <a class="card-link" data-toggle="collapse" href="#collapseOne">关注</a>
                        </div>
                        <div id="collapseOne" class="collapse" data-parent="#accordion">
                            <div class="card-body">
                                <template v-for="f in user_focus">
                                    <div>{% verbatim %} {{ f.username }} {% endverbatim %}</div>
                                </template>
                            </div>
                        </div>
                    </div>
                    <!--粉丝折叠-->
                    <div class="card">
                        <div class="card-header">
                            <a class="card-link" data-toggle="collapse" href="#collapseTwo">粉丝</a>
                        </div>
                        <div id="collapseTwo" class="collapse" data-parent="#accordion">
                            <div class="card-body">
                                <template v-for="vf in user_vic_focus">
                                    <div>{% verbatim %} {{ vf.username }} {% endverbatim %}</div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-1"></div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        Vue.filter('formatDate', function (value) {
            if(value){
                return moment(String(value)).format('LLL');
            }
        });
        //window.onload = function() {
            var app = new Vue({
                el: '#app',
                data: {
                    //登录表单数据模型
                    user_name_login:'',
                    user_password_login:'',

                    logined: false,//登录状态
                    logined_username:"游客",

                    //个人主页用户信息
                    user_id:{{ id }},
                    user_name: "",
                    user_focus_num: 0,
                    user_vic_focus_num: 0,
                    user_posts_num: 0,
                    user_focus:[],
                    user_vic_focus:[],
                    is_focus:false,//默认没关注
                    //私信
                    letter_input:"",
                    //微博
                    posts:[],
                    lastid:"",
                    //模态框
                    modal:{
                        id:"",//该推文id
                        type:1,
                        poster: "",
                        content:"",
                        img:"",
                        time:"",
                        likes:"",
                        hits:"",
                        comments:[],
                    },
                    inputModal:{
                        type:"",//comment or reply
                        id:"",//所属推文或所属评论的id
                        self_id:"",
                        vic_poster:"",
                        content:"",
                        at_list:[],
                        at_input:"",
                        at:""
                    },
                    postModal:{
                        self_id:"",
                        type:1,
                        img_input:"",
                        img_link:"",
                        at_input:"",
                        at_list:[],
                        at:"",
                        content:"",
                        allow_post:true//预留
                    },

                    message:''
                },
                watch:{
                    logined:function (nval, oval) {
                        if(nval===true){
                            this.post_logined_user_info();
                            this.check_is_focus();//登录才去查是否关注
                        }
                    },
                },
                methods: {
                    open_letterModal(){
                        this.letter_input="";
                        $('#letterModal').modal('show');
                    },
                    post_letter(){
                        //发送私信
                        this.$http.post('/letter',{c:this.letter_input,r:this.user_id},{emulateJSON:true}).then(function(res){
                            $('#letterModal').modal('hide');
                        },function(){
                            alert("私信发送失败")
                        });
                    },
                    private_index_go(id){
                        //跳转个人主页
                        var url="/privatego";
                        url=url+"/?id="+id;
                        window.location.href=url;
                    },
                    to_signout:function(){
                        //注销
                        window.location.href='/signout';
                    },
                    to_register(){
                        //注册
                        window.location.href='/signup';
                    },
                    to_forgetPassword(){
                        //忘记密码
                        window.location.href='/forgetpassword';
                    },
                    post_login_status:function(){
                        //请求登录状态
                        this.$http.post('/logstatus',{},{emulateJSON:true}).then(function(res){
                            if(res.body === "yes") this.logined=true;
                            else this.logined=false;
                        },function(){
                            alert("登录状态请求失败");
                        });
                    },
                    post_to_login(){
                        //登录
                        if(this.user_name_login===''||this.user_password_login==='')
                            alert("登录信息不能为空！");
                        else{
                            var json={};//封装json
                            json["u"]=this.user_name_login;
                            json["p"]=this.user_password_login;
                            this.$http.post('/signin',json,{emulateJSON:true}).then(function(res){
                                if(res.body==="ok")this.logined=true;
                                else{
                                    this.logined=false;
                                    alert("登录失败！");
                                }
                            },function(){
                                alert("登录请求失败");
                            });
                        }
                    },
                    judge_post_type(img){
                        if(img==="")
                            return 1;
                        var str=img.toLowerCase();
                        if(str.search(".jpg")!=-1||str.search(".png")!=-1||str.search(".gif")!=-1||str.search(".jpeg")!=-1){
                            return 1;
                        }
                        return 2;
                    },
                    post_this_all_posts:function(){
                        //获取这个人的所有推文
                        this.$http.post('/getpostposter',{id: this.user_id},{emulateJSON:true}).then(function(res){
                            var ps=res.body;
                            for(var p in ps){
                                var type=this.judge_post_type(ps[p].picture);
                                this.posts.push({
                                    id: ps[p].id,
                                    type: type,
                                    content: ps[p].content,
                                    img: ps[p].picture,
                                    poster: ps[p].poster,
                                    time: ps[p].time,//发布时间
                                    like: ps[p].likes,//点赞数
                                    reading: ps[p].hits//阅读量
                                });
                                this.lastid=ps[p].id;
                            }
                        },function(){
                            alert("推文信息请求失败")
                        });
                    },
                    post_this_all_vic_focus(){
                        //获取这个人的所有粉丝
                        this.$http.post('/getfans',{id: this.user_id},{emulateJSON:true}).then(function(res){
                            var ps=res.body;
                            for(var p in ps){
                                this.user_vic_focus.push(
                                    ps[p].focuser
                                );
                            }
                        },function(){
                            alert("粉丝信息请求失败")
                        });
                    },
                    post_this_all_focus(){
                        //获取这个人的所有关注的人
                        this.$http.post('/getfocus',{id: this.user_id},{emulateJSON:true}).then(function(res){
                            var ps=res.body;
                            for(var p in ps){
                                this.user_focus.push(
                                    ps[p].vic_focus
                                );
                            }
                        },function(){
                            alert("关注者信息请求失败")
                        });
                    },
                    post_this_user_info(){
                        //获取个人主页用户信息
                        this.$http.post('/userinfoid',{id:this.user_id},{emulateJSON:true}).then(function(res){
                            this.user_name=res.body.name;
                            this.user_focus_num=res.body.guanzhu;
                            this.user_vic_focus_num=res.body.fensi;
                            this.user_posts_num=res.body.tuiwen;
                        },function(){
                            alert("主页用户信息请求失败")
                        });
                    },
                    post_logined_user_info(){
                        //获取登录用户信息
                        this.$http.post('/userinfo',{},{emulateJSON:true}).then(function(res){
                            this.logined_username=res.body.name;
                        },function(){
                            alert("登录用户信息请求失败")
                        });
                    },
                    check_is_focus(){
                        //判断是否关注
                        this.$http.post('/isfocused',{id:this.user_id},{emulateJSON:true}).then(function(res){
                            if(res.body==="yes")
                                this.is_focus=true;
                            else
                                this.is_focus=false;
                        },function(){
                            alert("请求是否关注失败")
                        });
                    },
                    to_focus_him(){
                        //关注该用户
                        this.$http.post('/focus',{v:this.user_id},{emulateJSON:true}).then(function(res){
                            var url="/privatego";
                            url=url+"/?id="+this.user_id;
                            window.location.href=url;
                        },function(){
                            alert("关注失败")
                        });
                    },
                    open_modal(p){
                        this.post_add_reading(p.id);
                        for(var i in this.posts){
                            if(this.posts[i].id===p.id){
                                this.posts[i].reading+=1;
                            }
                        }
                        this.modal.id=p.id;
                        this.modal.type=p.type;
                        this.modal.poster=p.poster;
                        this.modal.content=p.content;
                        this.modal.time=p.time;
                        this.modal.img=p.img;
                        this.modal.likes=p.like;
                        this.modal.hits=p.reading;
                        this.modal.comments=[];
                        this.post_comments(p.id);
                        $('#myModal').modal('show');
                    },
                    post_add_reading(id){
                        //增加阅读量
                        this.$http.post('/hits',{id:id},{emulateJSON:true}).then(function(res){

                        },function(){
                            alert("阅读量增加失败")
                        });
                    },
                    post_comments(id){
                        //获取推文所属评论
                        this.$http.post('/getcommentpost',{id:id},{emulateJSON:true}).then(function(res){
                            var cm=res.body;
                            for(var c in cm){
                                this.modal.comments.push({
                                    id: cm[c].id,
                                    content: cm[c].content,
                                    time: cm[c].time,
                                    poster: cm[c].poster,
                                    target: "#"+cm[c].id
                                });
                            }
                        },function(){
                            alert("评论信息请求失败")
                        });
                    },
                    post_replies(comment){
                        //获取评论所属回复
                        this.$http.post('/getreplycomment',{id:comment.id},{emulateJSON:true}).then(function(res){
                            var rp=res.body;
                            var replies_comment=[];
                            for(var r in rp){
                                replies_comment.push({
                                    id: rp[r].id,
                                    content: rp[r].content,
                                    time: rp[r].time,
                                    poster: rp[r].poster,
                                    vic_reply: rp[r].vic_reply
                                });
                            }
                            Vue.set(comment,'replies',replies_comment);
                        },function(){
                            alert("回复信息请求失败")
                        });
                    },
                    update_modal(){
                        this.post_comment_or_reply();
                        this.modal.comments=[];
                        this.post_comments(this.modal.id);
                        this.post_at(this.inputModal.at_list,this.inputModal.self_id,this.inputModal.type);
                        $('#inputModal').modal('hide');
                    },
                    inputModal_check_at_input(){
                        var n=this.inputModal.at_input;
                        for(var i in this.inputModal.at_list){
                            if(this.inputModal.at_list[i].username===n){
                                alert("已@！！！");
                                return ;
                            }
                        }
                        this.$http.post('/atisexist',{name:n},{emulateJSON:true}).then(function(res){
                            this.inputModal.at=res.body;
                            if(this.inputModal.at==="error"){
                                alert("所@之人不存在！");
                            }
                            else{
                                this.inputModal.at_list.push(this.inputModal.at);
                            }
                        },function(){

                        });
                    },
                    post_comment_or_reply(){
                        //发评论或回复
                        if(this.inputModal.type==="comment"){
                            this.$http.post('/comment',{c:this.inputModal.content,b:this.inputModal.id},{emulateJSON:true}).then(function(res){

                            },function(){
                                alert("评论发送失败")
                            });
                        }
                        else{
                            this.$http.post('/reply',{c:this.inputModal.content,b:this.inputModal.id,u:this.inputModal.vic_poster.id},{emulateJSON:true}).then(function(res){

                            },function(){
                                alert("回复发送失败")
                            });
                        }
                    },
                    to_comment(modal){
                        this.inputModal.type="comment";
                        this.inputModal.id=modal.id;
                        this.inputModal.vic_poster=modal.poster;
                        this.inputModal.content="";
                        this.inputModal.at_input="";
                        this.inputModal.at_list=[];
                        this.inputModal.at="";
                        this.$http.post('/gettmpid',{},{emulateJSON:true}).then(function(res){
                            this.inputModal.self_id=res.body;
                        },function(){
                        });
                        $('#inputModal').modal('show');
                    },
                    to_reply(cmORrp,id){
                        this.inputModal.type="reply";
                        this.inputModal.id=id;
                        this.inputModal.vic_poster=cmORrp.poster;
                        this.inputModal.content="";
                        this.inputModal.at_input="";
                        this.inputModal.at_list=[];
                        this.inputModal.at="";
                        this.$http.post('/gettmpid',{},{emulateJSON:true}).then(function(res){
                            this.inputModal.self_id=res.body;
                        },function(){
                        });
                        $('#inputModal').modal('show');
                    },
                    post_i_like(){
                        //点赞
                        this.$http.post('/like',{v:this.modal.id},{emulateJSON:true}).then(function(res){
                            if(res.body==="ok"){
                                this.modal.likes+=1;
                                for(var i in this.posts){
                                    if(this.posts[i].id===this.modal.id){
                                        this.posts[i].like+=1;
                                    }
                                }
                            }
                            else{
                                alert("已点赞！")
                            }
                        },function(){
                            alert("点赞失败")
                        });
                    },
                    to_post(){
                        //this.postModal.allow_post=true;
                        this.postModal.img_input="";
                        this.postModal.img_link="";
                        this.postModal.at_input="";
                        this.postModal.at_list=[];
                        this.postModal.content="";
                        this.postModal.type=1;
                        this.$http.post('/gettmpid',{},{emulateJSON:true}).then(function(res){
                            this.postModal.self_id=res.body;
                        },function(){
                        });
                        $('#postModal').modal('show');
                    },
                    update_postModal_img(){
                        this.postModal.img_link=this.postModal.img_input;
                        this.postModal.type=this.judge_post_type(this.postModal.img_link);
                    },
                    post_postModal_to_post(){
                        if(this.postModal.content==="")
                        {
                            alert("推文内容不能为空");
                        }
                        else{
                            //this.postModal.allow_post=true;
                            //this.postModal_check_at_input();
                            //this.postModal.at_list.push({id:3,username:"limmy",email:"tianqi218@126.com"});
                            this.post_postModal_post();
                            this.post_at(this.postModal.at_list,this.postModal.self_id,"post");
                        }
                    },
                    postModal_check_at_input(){
                        //检查@字符串
                        //this.postModal.allow_post=false;
                        //var n=this.postModal.at_input.slice(1);
                        var n=this.postModal.at_input;
                        for(var i in this.postModal.at_list){
                            if(this.postModal.at_list[i].username===n){
                                alert("已@！！！");
                                return ;
                            }
                        }
                        this.$http.post('/atisexist',{name:n},{emulateJSON:true}).then(function(res){
                            this.postModal.at=res.body;
                            if(this.postModal.at==="error"){
                                alert("所@之人不存在！");
                                //this.postModal.allow_post=false;
                            }
                            else{
                                this.postModal.at_list.push(this.postModal.at);
                            }
                        },function(){

                        });
                    },
                    post_postModal_post(){
                        //发推
                        this.$http.post('/post',{c:this.postModal.content,pic:this.postModal.img_link},{emulateJSON:true}).then(function(res){
                            window.location.href='/';//直接刷页面
                        },function(){
                            alert("推文发送失败")
                        });
                    },
                    post_at(at_list, belong_id, type){
                        //发送@ type:post comment reply
                        for(var at in at_list){
                            this.$http.post('/at',{t:type,b:belong_id,v:at_list[at].id},{emulateJSON:true}).then(function(res){

                            },function(){

                            });
                        }
                    }
                }
            });
            app.post_login_status();
            app.post_this_user_info();
            app.post_this_all_posts();
            app.post_this_all_focus();
            app.post_this_all_vic_focus();
            //app.check_is_focus();
            $(window).scroll(function(){
                //变量scrollTop是滚动条滚动时，距离顶部的距离
                var scrollTop = document.documentElement.scrollTop||document.body.scrollTop;
                //变量windowHeight是可视区的高度
                var windowHeight = document.documentElement.clientHeight || document.body.clientHeight;
                //变量scrollHeight是滚动条的总高度
                var scrollHeight = (document.documentElement.scrollHeight||document.body.scrollHeight)-10;
             //滚动条到底部的条件
            if(scrollTop+windowHeight>=scrollHeight){
                 //动态加载微博
                        //app.post_ten_posts();
            }   
          });
       // };
    </script>
</body>
</html>