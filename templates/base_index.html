<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.12.5/umd/popper.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.staticfile.org/vue/2.2.2/vue.min.js"></script>
    <script src="https://cdn.staticfile.org/vue-resource/1.5.1/vue-resource.min.js"></script>
    <style>
        body{
            padding-top: 70px;
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div class="navbar navbar-expand-md bg-light fixed-top">
            <div class="container-fluid">
                <ul class="navbar-nav navbar-left nav-pills">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">主页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">通知</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">私信</a>
                    </li>
                </ul>
                <span class="navbar-text text-muted font-weight-bold">
                    迷你博客
                </span>
                <template v-if="logined">
                    <ul class="navbar-nav navbar-right">
                        <li><button type="button" class="btn btn-primary" v-on:click="to_post()">发微博</button></li>
                        <li><button type="button" v-on:click="to_signout" class="btn btn-danger">注销</button></li>
                    </ul>
                </template>
                <template v-else>
                    <ul class="navbar-nav navbar-right">
                        <li>
                            <input type="text" v-model="user_name_login" class="form-control" placeholder="用户名">
                        </li>
                        <li>
                            <input type="password" v-model="user_password_login" class="form-control" placeholder="密码">
                        </li>
                        <li>
                            <button type="button" v-on:click="post_to_login()" class="btn btn-primary">登录</button>
                        </li>
                        <li>
                            <button type="button" v-on:click="to_register()" class="btn btn-success">注册</button>
                        </li>
                        <li>
                            <button type="button" v-on:click="to_forgetPassword()" class="btn">忘记密码</button>
                        </li>
                    </ul>
                </template>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-1"></div>
                <div class="col-md-3">
                    <div class="card">
                        <img class="card-img-top" src="/static/tou.jpg" style="width:100%">
                        <div class="card-body">
                            <h4 class="card-title">{% verbatim %} {{ user_name }} {% endverbatim %}</h4>
                            <template v-if="logined">
                                <table>
                                    <tbody>
                                        <tr>
                                            <td class="text-primary">粉丝</td>
                                            <td class="text-primary">关注</td>
                                            <td class="text-primary">微博</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">{% verbatim %} {{ user_vic_focus }} {% endverbatim %}</td>
                                            <td class="text-muted">{% verbatim %} {{ user_focus }} {% endverbatim %}</td>
                                            <td class="text-muted">{% verbatim %} {{ user_posts }} {% endverbatim %}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </template>

                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <template v-for="p in posts">
                        <div class="card">
                            <div  v-on:click="open_modal(p)" class="card-body">
                                <h4>{% verbatim %} {{ p.poster.username }} {% endverbatim %}</h4>
                                <p>{% verbatim %} {{ p.time }} {% endverbatim %}</p>
                                <img v-bind:src="p.img" style="width:100%;">
                                <p>{% verbatim %} {{ p.content }} {% endverbatim %}</p>
                            </div>
                            <div class="card-footer">
                                <p>点赞数{% verbatim %} {{ p.like }} {% endverbatim %}</p>
                                <p>阅读量{% verbatim %} {{ p.reading }} {% endverbatim %}</p>
                            </div>
                        </div>
                    </template>
                    <!--推文模态框-->
                    <div class="modal fade" id="myModal" style="overflow: auto">
                        <div class="modal-dialog" aria-hidden="true">
                            <div class="modal-content">
                                <!-- 模态框头部 -->
                                <div class="modal-header">
                                    <h4 class="modal-title">{% verbatim %} {{ modal.poster.username }} {% endverbatim %}</h4>
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                </div>
                                <!-- 模态框主体 -->
                                <div class="modal-body">
                                    <img class="card-img-top" v-bind:src="modal.img" style="width:100%">
                                    <div>{% verbatim %} {{ modal.content }} {% endverbatim %}</div>
                                    <div>{% verbatim %} {{ modal.time }} {% endverbatim %}</div>
                                    <div>点赞数{% verbatim %} {{ modal.likes }} {% endverbatim %}</div>
                                    <div>阅读量{% verbatim %} {{ modal.hits }} {% endverbatim %}</div>
                                    <button v-on:click="post_i_like()">点赞</button>
                                    <button v-on:click="to_comment(modal)">评论</button>
                                    <!--评论-->
                                    <!--<button v-on:click="update_comment()">加载评论</button>
                                    <button v-on:click="update_replies()">加载回复</button>-->
                                    <template v-for="comment in modal.comments">
                                        <hr>
                                        <div>{% verbatim %} {{ comment.poster.username }} {% endverbatim %}</div>
                                        <div>{% verbatim %} {{ comment.time }} {% endverbatim %}</div>
                                        <div>{% verbatim %} {{ comment.content }} {% endverbatim %}</div>
                                        <button v-on:click="to_reply(comment,comment.id)">回复</button>
                                        <button data-toggle="collapse" v-bind:data-target="comment.target" v-on:click="post_replies(comment)">回复折叠</button>
                                        <div v-bind:id="comment.id" class="collapse">
                                            <template v-for="reply in comment.replies">
                                            <div>{% verbatim %} {{ reply.poster.username }} {% endverbatim %}回复{% verbatim %} {{ reply.vic_reply.username }} {% endverbatim %}</div>
                                            <div>{% verbatim %} {{ reply.time }} {% endverbatim %}</div>
                                            <div>{% verbatim %} {{ reply.content }} {% endverbatim %}</div>
                                            <button v-on:click="to_reply(reply,comment.id)">回复</button>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                                <!-- 模态框底部 -->
                                <div class="modal-footer">

                                </div>
                            </div>
                        </div>
                    </div>
                    <!--输入模态框-->
                    <div class="modal fade" id="inputModal">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <!-- 模态框头部 -->
                                <div class="modal-header">
                                    <h4 class="modal-title">对{% verbatim %} {{ inputModal.vic_poster.username }} {% endverbatim %}说</h4>
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                </div>
                                <!-- 模态框主体 -->
                                <div class="modal-body">
                                    <textarea type="text" v-model="inputModal.content" class="form-control" rows="5"></textarea>
                                </div>
                                <!-- 模态框底部 -->
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" v-on:click="update_modal()">提交</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--发推模态框-->
                    <div class="modal fade" id="postModal">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <!-- 模态框头部 -->
                                <div class="modal-header">
                                    <h4 class="modal-title">发微博</h4>
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                </div>
                                <!-- 模态框主体 -->
                                <div class="modal-body">
                                    <div>图片链接</div>
                                    <input type="text" v-model="postModal.img_input" class="form-control">
                                    <button type="button" class="btn" v-on:click="update_postModal_img()">更新</button>
                                    <img class="card-img-top" v-bind:src="postModal.img_link" alt="可添加图片" style="width:100%">
                                    <div>@<input type="text" v-model="postModal.at_input" class="form-control"></div>
                                    <textarea type="text" v-model="postModal.content" class="form-control" rows="5"></textarea>
                                </div>
                                <!-- 模态框底部 -->
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" v-on:click="post_postModal_to_post()">发表</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3"></div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        //var moment=require('moment');
       // Vue.filter('formatDate', function (value) {
           // if(value){
                //return moment(String(value)).format('MM/DD/YYYY hh:mm');
           // }
        //});
        //window.onload = function() {
            var app = new Vue({
                el: '#app',
                data: {
                    //登录表单数据模型
                    user_name_login:'',
                    user_password_login:'',

                    logined: false,//登录状态
                    //登录用户信息
                    user_name: '游客',
                    user_focus: 0,
                    user_vic_focus: 0,
                    user_posts: 0,
                    //微博
                    posts:[],
                    lastid:"",
                    //模态框
                    modal:{
                        id:"",//该推文id
                        poster: "",
                        content:"",
                        img:"",
                        time:"",
                        likes:"",
                        hits:"",
                        comments:[],
                    },
                    inputModal:{
                        type:"",//comment or reply
                        id:"",//所属推文或所属评论的id
                        vic_poster:"",
                        content:""
                    },
                    postModal:{
                        self_id:"",
                        img_input:"",
                        img_link:"",
                        at_input:"",
                        at_list:[],
                        content:"",
                        allow_post:true
                    },
                    message:''
                },
                watch:{
                    logined:function (nval, oval) {
                        if(nval===true){
                            this.post_user_info();
                        }
                    }
                },
                methods: {
                    to_signout:function(){
                        //注销
                        window.location.href='/signout';
                    },
                    to_register(){
                        //注册
                        window.location.href='/signup';
                    },
                    to_forgetPassword(){
                        //忘记密码
                        window.location.href='/forgetpassword';
                    },
                    post_login_status:function(){
                        //请求登录状态
                        this.$http.post('/logstatus',{},{emulateJSON:true}).then(function(res){
                            if(res.body === "yes") this.logined=true;
                            else this.logined=false;
                        },function(){
                            alert("登录状态请求失败");
                        });
                    },
                    post_to_login(){
                        //登录
                        if(this.user_name_login===''||this.user_password_login==='')
                            alert("登录信息不能为空！");
                        else{
                            var json={};//封装json
                            json["u"]=this.user_name_login;
                            json["p"]=this.user_password_login;
                            this.$http.post('/signin',json,{emulateJSON:true}).then(function(res){
                                if(res.body==="ok")this.logined=true;
                                else{
                                    this.logined=false;
                                    alert("登录失败！");
                                }
                            },function(){
                                alert("登录请求失败");
                            });
                        }
                    },
                    post_ten_posts:function(){
                        //获取十篇推文
                        var json={};
                        json["userid"]="";
                        json["num"]="10";
                        json["lastid"]=this.lastid;
                        this.$http.post('/getpost',json,{emulateJSON:true}).then(function(res){
                            var ps=res.body;
                            for(var p in ps){
                                this.posts.push({
                                    id: ps[p].id,
                                    content: ps[p].content,
                                    img: ps[p].picture,
                                    poster: ps[p].poster,
                                    time: ps[p].time,//发布时间
                                    like: ps[p].likes,//点赞数
                                    reading: ps[p].hits//阅读量
                                });
                                this.lastid=ps[p].id;
                            }
                        },function(){
                            alert("推文信息请求失败")
                        });
                    },
                    post_user_info(){
                        //获取登录用户信息
                        this.$http.post('/userinfo',{},{emulateJSON:true}).then(function(res){
                            this.user_name=res.body.name;
                            this.user_focus=res.body.guanzhu;
                            this.user_vic_focus=res.body.fensi;
                            this.user_posts=res.body.tuiwen;
                        },function(){
                            alert("用户信息请求失败")
                        });
                    },
                    open_modal(p){
                        if(this.logined===true){
                            this.post_add_reading(p.id);
                            for(var i in this.posts){
                                if(this.posts[i].id===p.id){
                                    this.posts[i].reading+=1;
                                }
                            }
                            this.modal.id=p.id;
                            this.modal.poster=p.poster;
                            this.modal.content=p.content;
                            this.modal.time=p.time;
                            this.modal.img=p.img;
                            this.modal.likes=p.like;
                            this.modal.hits=p.reading;
                            this.modal.comments=[];
                            this.post_comments(p.id);
                            $('#myModal').modal('show');
                        }
                    },
                    post_add_reading(id){
                        //增加阅读量
                        this.$http.post('/hits',{id:id},{emulateJSON:true}).then(function(res){

                        },function(){
                            alert("阅读量增加失败")
                        });
                    },
                    post_comments(id){
                        //获取推文所属评论
                        this.$http.post('/getcommentpost',{id:id},{emulateJSON:true}).then(function(res){
                            var cm=res.body;
                            for(var c in cm){
                                this.modal.comments.push({
                                    id: cm[c].id,
                                    content: cm[c].content,
                                    time: cm[c].time,
                                    poster: cm[c].poster,
                                    target: "#"+cm[c].id
                                });
                            }
                        },function(){
                            alert("评论信息请求失败")
                        });
                    },
                    post_replies(comment){
                        //获取评论所属回复
                        this.$http.post('/getreplycomment',{id:comment.id},{emulateJSON:true}).then(function(res){
                            var rp=res.body;
                            var replies_comment=[];
                            for(var r in rp){
                                replies_comment.push({
                                    id: rp[r].id,
                                    content: rp[r].content,
                                    time: rp[r].time,
                                    poster: rp[r].poster,
                                    vic_reply: rp[r].vic_reply
                                });
                            }
                            Vue.set(comment,'replies',replies_comment);
                        },function(){
                            alert("回复信息请求失败")
                        });
                    },
                    update_modal(){
                        this.post_comment_or_reply();
                        this.modal.comments=[];
                        this.post_comments(this.modal.id);
                        $('#inputModal').modal('hide');
                    },
                    post_comment_or_reply(){
                        //发评论或回复
                        if(this.inputModal.type==="comment"){
                            this.$http.post('/comment',{c:this.inputModal.content,b:this.inputModal.id},{emulateJSON:true}).then(function(res){

                            },function(){
                                alert("评论发送失败")
                            });
                        }
                        else{
                            this.$http.post('/reply',{c:this.inputModal.content,b:this.inputModal.id,u:this.inputModal.vic_poster.id},{emulateJSON:true}).then(function(res){

                            },function(){
                                alert("回复发送失败")
                            });
                        }
                    },
                    to_comment(modal){
                        this.inputModal.type="comment";
                        this.inputModal.id=modal.id;
                        this.inputModal.vic_poster=modal.poster;
                        this.inputModal.content="";
                        $('#inputModal').modal('show');
                    },
                    to_reply(cmORrp,id){
                        this.inputModal.type="reply";
                        this.inputModal.id=id;
                        this.inputModal.vic_poster=cmORrp.poster;
                        this.inputModal.content="";
                        $('#inputModal').modal('show');
                    },
                    post_i_like(){
                        //点赞
                        this.$http.post('/like',{v:this.modal.id},{emulateJSON:true}).then(function(res){
                            if(res.body==="ok"){
                                this.modal.likes+=1;
                                for(var i in this.posts){
                                    if(this.posts[i].id===this.modal.id){
                                        this.posts[i].like+=1;
                                    }
                                }
                            }
                            else{
                                alert("已点赞！")
                            }
                        },function(){
                            alert("点赞失败")
                        });
                    },
                    to_post(){
                        this.postModal.allow_post=true;
                        this.postModal.img_input="";
                        this.postModal.img_link="";
                        this.postModal.at_input="";
                        this.postModal.at_list=[];
                        this.postModal.content="";
                        this.postModal.self_id="";
                        $('#postModal').modal('show');
                    },
                    update_postModal_img(){
                        this.postModal.img_link=this.postModal.img_input;
                    },
                    post_postModal_to_post(){
                        if(this.postModal.content==="")
                        {
                            alert("推文内容不能为空");
                        }
                        else{
                            this.postModal_check_at_input();
                            if(this.postModal.allow_post===true){//可以发送
                                this.post_postModal_post();
                                this.post_at(this.postModal.at_list,this.postModal.self_id,"");
                            }
                            //$('#postModal').modal('hide');
                            window.location.href='/';//直接刷页面
                        }
                    },
                    postModal_check_at_input(){
                        //检查@字符串 提示那个错了
                        //this.postModal.allow_post=false;
                    },
                    post_postModal_post(){
                        //发推
                        this.$http.post('/post',{c:this.postModal.content,pic:this.postModal.img_link},{emulateJSON:true}).then(function(res){
                            this.postModal.self_id=res.body;
                        },function(){
                            alert("推文发送失败")
                        });
                    },
                    post_at(at_list, belong_id, type){
                        //发送@
                        for(var at in at_list){
                            this.$http.post('/at',{t:type,b:belong_id,v:at.id},{emulateJSON:true}).then(function(res){

                            },function(){

                            });
                        }
                    }
                }
            });
            app.post_login_status();
            app.post_ten_posts();
            window.onscroll = function(){
                //变量scrollTop是滚动条滚动时，距离顶部的距离
                var scrollTop = document.documentElement.scrollTop||document.body.scrollTop;
                //变量windowHeight是可视区的高度
                var windowHeight = document.documentElement.clientHeight || document.body.clientHeight;
                //变量scrollHeight是滚动条的总高度
                var scrollHeight = (document.documentElement.scrollHeight||document.body.scrollHeight)-1;
             //滚动条到底部的条件
            if(scrollTop+windowHeight>=scrollHeight){
                      //动态加载微博
               app.post_ten_posts();
            }   
          };
       // };
    </script>
</body>
</html>